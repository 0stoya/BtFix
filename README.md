# FixBraintreeWhereClause

A Magento 2 module that fixes malformed SQL aliases generated by certain extensions (commonly **Braintree**) in the **Admin Sales Order Grid**.

Some modules incorrectly construct SQL like:

```
`main_table`.`main_table`.created_at
```

which breaks the grid with errors such as:

```
SQLSTATE[42S22]: Column not found: 1054 Unknown column 'main_table.main_table.created_at'
```

This module cleans the SQL on-the-fly, ensuring your order grid loads correctly.

---

## ğŸ“¦ Installation

Install via Composer:

```bash
composer require 0stoya/btfix
```

Then enable the module:

```bash
bin/magento setup:upgrade
bin/magento cache:flush
```

That's it â€” no configuration required.

---

## ğŸš€ What This Module Fixes

Magentoâ€™s `sales_order_grid` uses the alias `main_table`.
Some payment/reporting modules incorrectly prepend the alias twice, causing SQL like:

```
main_table.main_table.status
```

This module:

1. Hooks into
   `Magento\Sales\Model\ResourceModel\Order\Grid\Collection::load()`
2. Inspects the generated SQL (`WHERE` clause)
3. Detects invalid patterns:

   * `` `main_table`.`main_table`.field ``
   * `main_table.main_table.field`
4. Automatically rewrites them to:

   * `` `main_table`.field ``
   * `main_table.field`
5. Allows the grid to execute normally.

It is safe, upgrade-proof, and does not override core or vendor files.

---

## ğŸ›  Compatibility

âœ” Magento 2.3.x
âœ” Magento 2.4.x
âœ” Fully compatible with Magento **2.4.8-p1**
âœ” Works alongside Braintree, PayPal, Adyen, Klarna, custom modules, etc.
âœ” No overrides â€” safe for upgrades

---

## âš™ï¸ Troubleshooting

### Still seeing errors?

Some extensions may inject malformed aliases into other SQL parts such as:

* `ORDER BY`
* `HAVING`

You can extend the cleaning list inside the plugin:

```php
$partsToClean = ['where', 'order', 'having'];
```

### Other aliases broken?

If another module uses a different alias, simply add another replacement rule.

---

## ğŸ“„ License

MIT License (or choose another if you prefer).

---
